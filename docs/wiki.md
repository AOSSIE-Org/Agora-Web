# Welcome to the Agora Web Wiki.


_Frontend for [Agora](https://gitlab.com/aossie/Agora/): An Electronic Voting Library implemented in Scala_
This project is created using play framework 2.5 seeds [template](https://github.com/playframework/play-scala-seed.g8).

## Table of contents

- [Introduction](#introduction)
- [Environment variables](#environment-variables)
- [Authentication](#authentication)
- [Database](#database)
- [Email Client](#email-client)
- [Vote Counting Algorithms](#voting-counting-Algorithms)
- [Demo](#demo)

To know how to run the Project, please see [README.md](https://gitlab.com/Thuva4/Agora-Web/blob/master/README.md) file on the repository.


## Introduction

The scope of the project to implement a front end for [Agora](https://gitlab.com/aossie/Agora) project where public can access the functions of the Agora library. If You want to see the functionalities of the `Agora Web`, please see [Functionality](functionality) wiki page.

## Environment variables

Before Starting to work with the project You need to configure the environment variables
for the Project. Here, environment variables are described:

|  Variable 	|  Mandatory 	|   Description
|     ---	|      ---	|       ---
|  APPLICATION_SECRET | Yes |   Secret key for play application	   	
|  MONGODB_URI        | Yes |   `mongodb://` URI of the MongoDB database
|  SENDGRID_USERNAME  | Yes | Username [Sendgrid](https://sendgrid.com/) account used to send mails in name of the system.  	   	
|  SENDGRID_PASSWORD  | In Production mode | Plain text password of sendgrid account.  	   	
|  COOKIE_SECRET_KEY  | In Production mode | Secret key to sing cookies generated by Silhouette. 	   	
|  COOKIE_ENCRYPT_KEY | In Production mode | Secret key to encrypt cookies generated by Silhouette.
|  OAUTH1_COOKIE_SECRET_KEY | In Production mode |  Secret key to sign cookies from the Oauth1.
|  OAUTH1_COOKIE_ENCRYPT_KEY | In Production mode |  Secret key to encrypt cookies from the Oauth1.   	   	
|  OAUTH2_COOKIE_SECRET_KEY | In Production mode | Secret key to encrypt cookies from the Oauth2.  	   	
|  FACEBOOK_CLIENT_ID | To use Facebook authentication    | Facebook client ID is used to identify the application   	   	
|  FACEBOOK_CLIENT_SECRET| To use Facebook authentication | Facebook Client Secret is used to authenticate the identity of the application.  	
|  GOOGLE_CLIENT_ID | To use Google authentication   |   Google client ID is used to identify the application   	   		   	
|  GOOGLE_CLIENT_SECRET	 | To use Google authentication |  Google Client Secret is used to authenticate the identity of the application.  	
|  VK_CLIENT_ID | To use VK authentication   |  VK client ID is used to identify the application   	   		   	
|  VK_CLIENT_SECRET | To use VK authentication        |   VK Client Secret is used to authenticate the identity of the application.  		   	   	   	
|  TWITTER_CONSUMER_KEY	|  To use Twitter authentication        | Twitter Consumer key is used to identify the application   	   		   	
|  TWITTER_CONSUMER_SECRET |  To use Twitter authentication	        |  Twitter Consumer Secret is used to authenticate the identity of the application.  	
|  XING_CONSUMER_KEY | To use Xing authentication        |  Xing Consumer key is used to identify the application   	   		   	
|  XING_CONSUMER_SECRET | To use Xing authentication	        |   Xing Consumer Secret is used to authenticate the identity of the application.  	

For more info please check these links,

1. [Facebook](https://developers.facebook.com/)
2. [Google](https://console.cloud.google.com)
3. [Twitter](https://dev.twitter.com/)
4. [Xing](https://dev.xing.com/)
5. [VK](https://vk.com/dev)


# Authentication

We have used Silhouette for the `Authentication` purpose.

> Silhouette is an authentication library for Play Framework applications that supports several authentication methods, including OAuth1, OAuth2, OpenID, CAS, Credentials, Basic Authentication or custom authentication schemes.

We used [Oauth2](https://oauth.net/2/) framework to get the details from the service providers. Following diagram will explain the authentication scenario.

![webflow](https://developers.google.com/accounts/images/webflow.png)

*Get from Google Developer page*

For more details please check these links,

1. [Silhouette](https://www.silhouette.rocks/)
2. [Token Based Authentication](https://auth0.com/learn/token-based-authentication-made-easy/)

## Database

We have used MongoDB as the persistent storage for our project. We  chose MongoDB for following reasons,
1. High Write Load
2. High Availability in an Unreliable Environment (Cloud storage)
3. Data Set is Going to be Big (Election Data can go upto 1Gb)  
4. In our case Election Schema is Not Stable.

We use [Casbah](http://mongodb.github.io/casbah/3.1/) to connect the MongoDB.We used Salat with casbah to serialize the case classes into BSON format.

> `Casbah` is a Scala toolkit for MongoDB.

>  `Salat` is a bi-directional Scala case class serialization library that leverages MongoDB's DBObject (which uses BSON underneath) as its target format.

 We created a Object called MongoDBConnection to Connect with the Database. We control different database connection using the object.
Example Code,
 ```
     def getConnection: MongoCollection = {
        val mongoUri    =  MongoClientURI(ConfigFactory.load().getString("mongodb.default.uri"))
        val mongoClient = MongoClient(mongoUri)
        val db          = mongoClient("Database Name")
        db("electionData")
      }
 ```

See [Environment variables](#environment-variables) Section to learn about `mongoUri`.

 Examples for salat serialization are shown below,

 1. Convert Model into BSON Data.

 ```
     val bsonElection = grater[Election].asDBObject(election)
 ```
2. Retrieve Model from BSON Data.

 ```
    val election = grater[Election].asObject(bsonElection)
 ```

For more details please check these links,
1. [Casbah](https://mongodb.github.io/casbah/)
2. [Salat](https://github.com/salat/salat)

## Email Client

We used play mailer module to build and send email messages. For our app We want those funtionalities in following use cases.
1. Sending invitation and verification code for voter.
2. Sending admin link to guest users while creating the election

Configure the play mailer in `application.conf`.
 ```
    play.mailer {
      host = "example.com" // (mandatory)
      port = 25 // (defaults to 25)
      ssl = no // (defaults to no)
      tls = no // (defaults to no)
      tlsRequired = no // (defaults to no)
      user = null // (optional)
      password = null // (optional)
      debug = no // (defaults to no, to take effect you also need to set the log level to "DEBUG" for the application logger)
      timeout = null // (defaults to 60s in milliseconds)
      connectiontimeout = null // (defaults to 60s in milliseconds)
      mock = no // (defaults to no, will only log all the email properties instead of sending an email)
    }
 ```
 Check the [Environment variables](#environment-variables) Section to learn more.

 Example Code for sending mail,
```
    val email = Email(
          "Simple email",
          "Mister FROM <from@email.com>",
          Seq("Miss TO <to@email.com>"),
          // adds attachment
          attachments = Seq(
            AttachmentFile("attachment.pdf", new File("/some/path/attachment.pdf")),
            // adds inline attachment from byte array
            AttachmentData("data.txt", "data".getBytes, "text/plain", Some("Simple data"), Some(EmailAttachment.INLINE)),
            // adds cid attachment
            AttachmentFile("image.jpg", new File("/some/path/image.jpg"), contentId = Some(cid))
          ),
          // sends text, HTML or both...
          bodyText = Some("A text message"),
          bodyHtml = Some(s"""<html><body><p>An <b>html</b> message with cid <img src="cid:$cid"></p></body></html>""")
        )
```

Example codes are taken from [Play-Mailer](https://github.com/playframework/play-mailer) examples.

Select any Email Delivery Service to get the user, password for configuration. We are using Sendgrid for this purpose.

For more details please check these links,
1. [Paly-Mailer](https://github.com/playframework/play-mailer)
2. [Sendgrid](https://sendgrid.com/)

# Vote Counting Algorithms

We are using the algorithms from the [Agora](https://gitlab.com/aossie/Agora) Library. In project `models.services.Countvotes` object provide the functions for counting votes for the election. To add a new Algorithm into the system  please do the following:
1. Check is the Ballot view available in the `app/views/ballot` directory
2. If yes skip this step, else create a ballot view according to the voting process.
3. Add new algorithm into the `algo` list in the `addElection.scala.html` and `editElection.scala.html`.
4. Then define a case statement in the models.services.Countvotes.countvotesMethod method to handle the new algorithm. Example code.


 ```
    case "new algorithm name" => {
        val result = new_algorithm_name.winners(Election.weightedElectionToACTElection(elecion),candidate,1)
        return result
    }
```

# Demo

Do you want to see it in action? Here is a working version deployed to heroku

1. Development Version : https://fathomless-taiga-85734.herokuapp.com/
1. Production Version : https://agora-web-aossie.herokuapp.com
